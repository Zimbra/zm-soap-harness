<project name="MyProject" default="" basedir=".">

	<property environment="env"/>
	<taskdef name="purge" classname="com.dallaway.ant.Purge"/>

	<property name="vStudioIDE.dir"  location="/Program Files/Microsoft Visual Studio 8/Common7/IDE"/>
	<property name="devenv.com"  location="${vStudioIDE.dir}/devenv.com"/>

	<property name="archive.dir"  location="${ARCHIVEROOT}"/>
	<tstamp>
		<format property="archive.id" pattern="yyyyMMddHHmmss"/>
	</tstamp>
	<property name="dist.dir"  location="${archive.dir}/${archive.id}"/>
	<property name="dist.sync.dir"  location="${dist.dir}/synclient"/>
	<property name="distlatest.dir"  location="${archive.dir}/zco"/>
	<property name="zimbraqa.dir"  location="${GITROOT}"/>
	<property name="zimbraqa.src.dir"  location="${zimbraqa.dir}/src"/>
	<property name="zimbraqa.csharp.dir"  location="${zimbraqa.src.dir}/vstudio/cs"/>
	<property name="zimbraqa.bin.dir"  location="${zimbraqa.src.dir}/bin"/>
	<property name="zimbraqa.conf.dir"  location="${zimbraqa.dir}/conf"/>
	<property name="zimbraqa.data.dir"  location="${zimbraqa.dir}/data"/>
	<property name="driver.zco.dir"  location="${zimbraqa.csharp.dir}/mapiDriver/ZcoDriver"/>
	<property name="driver.zco.sln"  location="${driver.zco.dir}/ZcoDriver.sln"/>
	<property name="driver.migration.dir"  location="${zimbraqa.csharp.dir}/mapiDriver/MigrationDriver"/>
	<property name="driver.migration.sln"  location="${driver.migration.dir}/MigrationDriver.sln"/>

	<target name="msbuildclean" description="clean up build files" >
		<exec executable="${devenv.com}" dir="${driver.zco.dir}" failonerror="true">
			<arg line="${driver.zco.sln}"/>
			<arg line="/clean Debug"/>
			<arg line="/project clientTests"/>
		</exec>
	</target>	

	<target name="msbuilddistlatest" depends="zcopackage,zmigrationpackage" description="copy files from the current build to the 'latest' folder" >
		<mkdir dir="${distlatest.dir}"/>
		<delete>
			<fileset dir="${distlatest.dir}"/>
		</delete>
		<copy todir="${distlatest.dir}">
			<fileset dir="${dist.dir}"/>
		</copy>
	</target>

	<target name="zcopackage" depends="zimbrapackage" description="Create ZCO structure" >
		<copy todir="${dist.sync.dir}">
			<fileset dir="${driver.zco.dir}/clientTests/bin/Debug"/>
		</copy>
	</target>

	<target name="zimbrapackage">
		<mkdir dir="${dist.sync.dir}"/>
		<copy todir="${dist.sync.dir}">
			<fileset file="${zimbraqa.bin.dir}/runreports_n.sh"/>
		</copy>
		<mkdir dir="${dist.sync.dir}/conf"/>
		<copy todir="${dist.sync.dir}/conf">
			<fileset dir="${zimbraqa.conf.dir}"/>
		</copy>
		<mkdir dir="${dist.sync.dir}/data"/>
		<copy todir="${dist.sync.dir}/data">
			<fileset dir="${zimbraqa.data.dir}"/>
		</copy>
	</target>

	
	<target name="zmigrationpackage" depends="zimbrapackage" description="Create Migration structure" >
		<copy todir="${dist.sync.dir}">
			<fileset dir="${driver.migration.dir}/NewPSTDataTests/bin/Debug"/>
			<fileset dir="${driver.migration.dir}/ExchangeDataTests/bin/Debug"/>
		</copy>
	</target>

<target name="CompressBuildFile" depends="msbuilddistlatest" description = "Clean up build files">
	<tar destfile="${ARCHIVEROOT}/${archive.id}.tar" basedir="${dist.dir}"/>
	<gzip destfile="${ARCHIVEROOT}/${archive.id}.tgz" src="${ARCHIVEROOT}/${archive.id}.tar"/>
	
	<tar destfile="${ARCHIVEROOT}/zco.tar" basedir="${distlatest.dir}"/>
	<gzip destfile="${ARCHIVEROOT}/zco.tgz" src="${ARCHIVEROOT}/zco.tar"/>


	<!-- ZCO is first converted to tar.tgz then to .tgz because it seems it needs mapper type "Glob"	-->
	<!--<copy todir="${ARCHIVEROOT}" >
	    <fileset dir="${ARCHIVEROOT}" includes="zco.tar.tgz"/>
	    <mapper type="glob" from="*.tar.tgz" to="*.tgz"/>
	  </copy>-->
	
	<checksum file="${ARCHIVEROOT}/zco.tgz"/>
</target>



<target name="BuildCleanup" depends="CompressBuildFile" description = "Clean up build files">
	
	 <delete dir="${dist.dir}"/>
	 <delete dir="${distlatest.dir}"/>
	 <purge test="false" keep="7">
		<fileset dir="${archive.dir}"/>
	</purge>
</target>

<target name="CopyLatestToTDrive" depends="BuildCleanup" description = "copy latest.tgz to T: drive">
</target>
</project>

