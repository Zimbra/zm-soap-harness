<project name="MyProject" default="" basedir=".">

	<property environment="env"/>
	<taskdef name="purge" classname="com.dallaway.ant.Purge"/>

	<property name="vStudioIDE.dir"  location="/Program Files/Microsoft Visual Studio 8/Common7/IDE"/>
	<property name="devenv.com"  location="${vStudioIDE.dir}/devenv.com"/>

	<!--<property name="P4ROOT"  location="/jenkins/jobs/ZCOMigrationHelixJob/workspace/zimbra/helix"/>-->

	<property name="archive.dir"  location="${ARCHIVEROOT}"/>
	<tstamp>
		<format property="archive.id" pattern="yyyyMMddHHmmss"/>
	</tstamp>
	<property name="dist.dir"  location="${archive.dir}/${archive.id}"/>
	<property name="dist.sync.dir"  location="${dist.dir}/eas"/>
	<property name="distlatest.dir"  location="${archive.dir}/eas"/>
	<property name="zimbraqa.dir"  location="${P4ROOT}/ZimbraQA"/>
	<property name="zimbrasync.src.dir"  location="${P4ROOT}/ZimbraSync/src/java"/>
	<property name="zimbraqa.src.dir"  location="${zimbraqa.dir}/src"/>
	<property name="zimbraqa.csharp.dir"  location="${zimbraqa.src.dir}/vstudio/cs"/>
	<property name="zimbraqa.bin.dir"  location="${zimbraqa.src.dir}/bin"/>
	<property name="zimbraqa.conf.dir"  location="${zimbraqa.csharp.dir}/easHarness/conf"/>
	<property name="zimbraqa.data.dir"  location="${zimbraqa.csharp.dir}/easHarness/data"/>
	<property name="driver.eas.dir"  location="${zimbraqa.csharp.dir}/easHarness"/>
	<property name="driver.eas.sln"  location="${driver.eas.dir}/easHarness.sln"/>

	<target name="msbuildclean" description="clean up build files" >
		<exec executable="${devenv.com}" dir="${driver.eas.dir}" failonerror="true">
			<arg line="${driver.eas.sln}"/>
			<arg line="/clean Debug"/>
			<arg line="/project Tests"/>
		</exec>
	</target>	

	<target name="msbuilddistlatest" depends="easpackage" description="copy files from the current build to the 'latest' folder" >
		<mkdir dir="${distlatest.dir}"/>
		<delete>
			<fileset dir="${distlatest.dir}"/>
		</delete>
		<copy todir="${distlatest.dir}">
			<fileset dir="${dist.dir}"/>
		</copy>
	</target>

	<target name="easpackage" depends="zimbrapackage" description="Create EAS structure" >
		<mkdir dir="${dist.sync.dir}/conf"/>
		<copy todir="${dist.sync.dir}/conf">
			<fileset dir="${zimbraqa.conf.dir}"/>
		</copy>
		<mkdir dir="${dist.sync.dir}/data"/>
		<copy todir="${dist.sync.dir}/data">
			<fileset dir="${zimbraqa.data.dir}"/>
		</copy>
		<copy todir="${dist.sync.dir}">
			<fileset dir="${driver.eas.dir}/Tests/bin/Debug"/>
		</copy>
		<mkdir dir="${dist.sync.dir}/src/java"/>
		<copy todir="${dist.sync.dir}/src/java">
			<fileset dir="${zimbrasync.src.dir}"/>
		</copy>
	</target>

	<target name="zimbrapackage">
		<mkdir dir="${dist.sync.dir}"/>
		<copy todir="${dist.sync.dir}">
			<fileset file="${zimbraqa.bin.dir}/runreports_n.sh"/>
		</copy>
	</target>

<target name="CompressBuildFile" depends="msbuilddistlatest" description = "Clean up build files">
	<tar destfile="${ARCHIVEROOT}/${archive.id}.tar" basedir="${dist.dir}"/>
	<gzip destfile="${ARCHIVEROOT}/${archive.id}.tgz" src="${ARCHIVEROOT}/${archive.id}.tar"/>
	
	<tar destfile="${ARCHIVEROOT}/eas.tar" basedir="${distlatest.dir}"/>
	<gzip destfile="${ARCHIVEROOT}/eas.tgz" src="${ARCHIVEROOT}/eas.tar"/>


	<!-- ZCO is first converted to tar.tgz then to .tgz because it seems it needs mapper type "Glob"	-->
	<!--<copy todir="${ARCHIVEROOT}" >
	    <fileset dir="${ARCHIVEROOT}" includes="eas.tar.tgz"/>
	    <mapper type="glob" from="*.tar.tgz" to="*.tgz"/>
	  </copy>-->
	
	<checksum file="${ARCHIVEROOT}/eas.tgz"/>
</target>



<target name="BuildCleanup" depends="CompressBuildFile" description = "Clean up build files">
	
	 <delete dir="${dist.dir}"/>
	 <delete dir="${distlatest.dir}"/>
	 <purge test="false" keep="7">
		<fileset dir="${archive.dir}"/>
	</purge>
</target>

<target name="CopyLatestToTDrive" depends="BuildCleanup" description = "copy latest.tgz to T: drive">
</target>
</project>