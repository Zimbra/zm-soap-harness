<t:tests xmlns:t="urn:zimbraTestHarness">

<t:property name="today" value="${CURRDATE}"/>
<t:property name="meeting.subject1" value="Test Meeting 1"/>
<t:property name="meeting.subject2" value="Test Meeting 2"/>

<t:property name="user1.name" value="user1@${defaultdomain.name}"/>
<t:property name="user1.password" value="test123"/>
<t:property name="user2.name" value="user2@${defaultdomain.name}"/>
<t:property name="user2.password" value="test123"/>
<t:property name="user3.name" value="user3@${defaultdomain.name}"/>
<t:property name="user3.password" value="test123"/>
<t:property name="user4.name" value="user4@${defaultdomain.name}"/>
<t:property name="user4.password" value="test123"/>

<t:property name="uid1" value="1-${TIME}-${COUNTER}"/>
<t:property name="uid2" value="2-${TIME}-${COUNTER}"/>
<t:property name="uid3" value="3-${TIME}-${COUNTER}"/>
<t:property name="uid4" value="4-${TIME}-${COUNTER}"/>

<t:test_case testcaseid="CalendarMove" type="smoke" areas="dev_internal">
    <t:objective>Calendar Move Tests</t:objective>

    <t:property name="uri" value="${admin.uri}"/>

    <t:test id="ping">
      <t:request>
        <PingRequest xmlns="urn:zimbraAdmin"/>
      </t:request>
      <t:response>
        <t:select path="//admin:PingResponse"/>
      </t:response>
    </t:test>

    <t:property name="uri" value="${mailclient.uri}"/>

    <!-- Clear on-behalf-of -->
    <t:property name="target" value=""/>

    <!-- Login as user1 -->
    <t:test id="login user1">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user1.name}</account>
          <password>${user1.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

	<t:property name="authToken" value="${authToken}"/>
	<t:test>
		<t:request>
			<GetInfoRequest xmlns="urn:zimbraAccount"/>
		</t:request>
		<t:response>
			<t:select path="//acct:GetInfoResponse/acct:id" set="account1.id"/> 
		</t:response>
	</t:test>
    <!-- Empty the Calendar folder -->
    <t:test id="empty calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="10" op="empty"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action" attr="id" match="10"/>
      </t:response>
    </t:test>

    <!-- Grant calendar admin rights to user2 -->
    <t:test id="grant to user2">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action op="grant" id="10">
            <grant gt="usr" d="${user2.name}" perm="rwidx"/>
          </action>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse"/>
      </t:response>
    </t:test>

    <!-- Login as user3 -->
    <t:test id="login user3">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user3.name}</account>
          <password>${user3.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

	<t:property name="authToken" value="${authToken}"/>
	<t:test>
		<t:request>
			<GetInfoRequest xmlns="urn:zimbraAccount"/>
		</t:request>
		<t:response>
			<t:select path="//acct:GetInfoResponse/acct:id" set="account3.id"/> 
		</t:response>
	</t:test>
	
    <!-- Empty the Calendar folder -->
    <t:test id="empty calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="10" op="empty"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action" attr="id" match="10"/>
      </t:response>
    </t:test>

    <!-- Grant calendar admin rights to user2 -->
    <t:test id="grant to user2">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action op="grant" id="10">
            <grant gt="usr" d="${user2.name}" perm="rwidx"/>
          </action>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse"/>
      </t:response>
    </t:test>

    <!-- Login as user2 -->
    <t:test id="login user2">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user2.name}</account>
          <password>${user2.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

	<t:property name="authToken" value="${authToken}"/>
	<t:test>
		<t:request>
			<GetInfoRequest xmlns="urn:zimbraAccount"/>
		</t:request>
		<t:response>
			<t:select path="//acct:GetInfoResponse/acct:id" set="account2.id"/> 
		</t:response>
	</t:test>
	
    <!-- Empty the Calendar folder -->
    <t:test id="empty calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="10" op="empty"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action" attr="id" match="10"/>
      </t:response>
    </t:test>

    <!-- Add user1's calendar to user2's view -->
    <t:test id="mount user1 calendar">
      <t:request>
        <CreateMountpointRequest xmlns="urn:zimbraMail">
          <link l="1" name="User1's Calendar"
                owner="${user1.name}"
                path="Calendar"
                view="appointment"
                color="3"/>
        </CreateMountpointRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:CreateMountpointResponse/mail:link">
          <t:select attr="id" set="u1CalFolderId"/>
          <t:select attr="zid" set="account1.id"/>
          <t:select attr="rid" set="u1CalFolderRid"/>
        </t:select>
      </t:response>
    </t:test>
    <t:property name="u1CalFolderIdFQ" value="${account1.id}:${u1CalFolderRid}"/>

    <!-- Add user3's calendar to user2's view -->
    <t:test id="mount user3 calendar">
      <t:request>
        <CreateMountpointRequest xmlns="urn:zimbraMail">
          <link l="1" name="User3's Calendar"
                owner="${user3.name}"
                path="Calendar"
                view="appointment"
                color="4"/>
        </CreateMountpointRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:CreateMountpointResponse/mail:link">
          <t:select attr="id" set="u3CalFolderId"/>
          <t:select attr="zid" set="account3.id"/>
          <t:select attr="rid" set="u3CalFolderRid"/>
        </t:select>
      </t:response>
    </t:test>
    <t:property name="u3CalFolderIdFQ" value="${account3.id}:${u3CalFolderRid}"/>

    <!-- Login as user4 -->
    <t:test id="login user4">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user4.name}</account>
          <password>${user4.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Empty the Calendar folder -->
    <t:test id="empty calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="10" op="empty"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action" attr="id" match="10"/>
      </t:response>
    </t:test>


    <!-- ################################################################################### -->

    <!-- user1 invites user4.  Move user1's meeting around. -->

    <t:property name="subject" value="Recurring Meeting with Attendee"/>

    <!-- Login as user1 -->
    <t:test id="user1">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user1.name}</account>
          <password>${user1.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Create an personal appointment, recurring with some exceptions -->
    <t:test required="true" id="personal with recurrence and exceptions">
      <t:request>
        <SetAppointmentRequest xmlns="urn:zimbraMail" l="10">
          <default ptst="AC">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070716T120000" tz="PacificTime"/>
                  <e d="20070716T130000" tz="PacificTime"/>
                  <or name="Demo User One" a="${user1.name}"/>
                  <at a="${user4.name}" role="REQ" ptst="NE"/>
                  <recur>
                    <add>
                      <rule freq="DAI">
                        <interval ival="1"/>
                        <count num="5"/>
                      </rule>
                    </add>
                  </recur>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This is the series.</content>
              </mp>
            </m>
          </default>
          <except ptst="TE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070718T130000" tz="PacificTime"/>
                  <e d="20070718T140000" tz="PacificTime"/>
                  <exceptId d="20070718T120000" tz="PacificTime"/>
                  <or name="Demo User One" a="${user1.name}"/>
                  <at a="${user4.name}" role="REQ" ptst="NE"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one begins an hour later than usual.</content>
              </mp>
            </m>
          </except>
          <except ptst="DE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070720T140000" tz="PacificTime"/>
                  <e d="20070720T150000" tz="PacificTime"/>
                  <exceptId d="20070720T120000" tz="PacificTime"/>
                  <or name="Demo User One" a="${user1.name}"/>
                  <at a="${user4.name}" role="REQ" ptst="NE"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one begins two hours later than usual.</content>
              </mp>
            </m>
          </except>
          <cancel>
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp allDay="0"
                      name="${subject}"
                      uid="${uid1}"
                      seq="1"
                >
                  <s d="20070717T120000" tz="PacificTime"/>
                  <exceptId d="20070717T120000" tz="PacificTime"/>
                  <or name="Demo User One" a="${user1.name}"/>
                  <at a="${user4.name}" role="REQ" ptst="NE"/>
                </comp>
              </inv>
              <mp ct="multipart/alternative">
                <mp ct="text/plain">
                  <content>This one is canceled.</content>
                </mp>
                <mp ct="text/html">
                  <content>&lt;html&gt;&lt;body&gt;This one is canceled.&lt;/body&gt;&lt;/html&gt;</content>
                </mp>
              </mp>
            </m>
          </cancel>
          <cancel>
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp allDay="0"
                      name="${subject}"
                      uid="${uid1}"
                      seq="1"
                >
                  <s d="20070719T120000" tz="PacificTime"/>
                  <exceptId d="20070719T120000" tz="PacificTime"/>
                  <or name="Demo User One" a="${user1.name}"/>
                  <at a="${user4.name}" role="REQ" ptst="NE"/>
                </comp>
              </inv>
              <mp ct="multipart/alternative">
                <mp ct="text/plain">
                  <content>This one is also canceled.</content>
                </mp>
                <mp ct="text/html">
                  <content>&lt;html&gt;&lt;body&gt;This one is also canceled.&lt;/body&gt;&lt;/html&gt;</content>
                </mp>
              </mp>
            </m>
          </cancel>
        </SetAppointmentRequest>
     </t:request>
     <t:response>
        <t:select path="//mail:SetAppointmentResponse" attr="calItemId" set="apptId"/>
     </t:response>
    </t:test>

    <!-- Login as user2 -->
    <t:test id="user2">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user2.name}</account>
          <password>${user2.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- View user1's meetings -->
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    <!-- Move it from user1's calendar (remote) to user3's calendar (remote) -->
    <!--
    <t:test id="move from user1 to user3">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="move" l="${u3CalFolderId}"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user3's meetings -->
    <!--
    <t:test id="view user3 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u3CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u3CalItemId"/>
          <t:select attr="invId" set="u3InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it from user1's calendar (remote) to user2's calendar (local) -->
    <!--
    <t:test id="move from user1 to user2">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u3CalItemId}" op="move" l="10"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u3CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user2's meetings -->
    <!--
    <t:test id="view user2 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="10"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u2CalItemId"/>
          <t:select attr="invId" set="u2InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it back from user2's calendar (local) to user1's calendar (remote) -->
    <!--
    <t:test id="move from user2 to user1">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u2CalItemId}" op="move" l="${u1CalFolderId}"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u2CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user1's meetings -->
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    <!-- Get the event's ms/rev -->
    <!--
    <t:test>
      <t:request>
        <GetMsgRequest xmlns="urn:zimbraMail">
          <m id="${u1InvId}"/>
        </GetMsgRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:GetMsgResponse/mail:m">
          <t:select attr="ms" set="u1ModSeq"/>
          <t:select attr="rev" set="u1Rev"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it from user1's calendar (remote) to user2's calendar (local) with edits -->
    <!--
    <t:test id="move from user1 to user2 with edits">
      <t:request>
        <ModifyAppointmentRequest xmlns="urn:zimbraMail" id="${u1InvId}" ms="${u1ModSeq}" rev="${u1Rev}">
          <m l="10">
            <inv>
              <tz id="PacificTime" stdoff="-480" dayoff="-420">
                <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
              </tz>
              <comp fb="B" transp="O" allDay="0"
                    name="${subject}" loc="edit #1"
                    uid="${uid1}"
              >
                <s d="20070716T120000" tz="PacificTime"/>
                <e d="20070716T130000" tz="PacificTime"/>
                <or name="Demo User One" a="${user1.name}"/>
                <at a="${user4.name}" role="REQ" ptst="NE"/>
                <recur>
                  <add>
                    <rule freq="DAI">
                      <interval ival="1"/>
                      <count num="5"/>
                    </rule>
                  </add>
                </recur>
              </comp>
            </inv>
            <su>${subject}</su>
            <mp ct="text/plain">
              <content>edit #1</content>
            </mp>
          </m>
        </ModifyAppointmentRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ModifyAppointmentResponse"/>
      </t:response>
    </t:test>
	-->
    <!-- View user2's meetings -->
    <!--
    <t:test id="view user2 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="10"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u2CalItemId"/>
          <t:select attr="invId" set="u2InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Get the event's ms/rev -->
    <!--
    <t:test>
      <t:request>
        <GetMsgRequest xmlns="urn:zimbraMail">
          <m id="${u2InvId}"/>
        </GetMsgRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:GetMsgResponse/mail:m">
          <t:select attr="ms" set="u2ModSeq"/>
          <t:select attr="rev" set="u2Rev"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it back from user2's calendar (local) to user1's calendar (remote) with edits -->
    <!--
    <t:test id="move from user2 to user1 with edits">
      <t:request>
        <ModifyAppointmentRequest xmlns="urn:zimbraMail" id="${u2InvId}" ms="${u2ModSeq}" rev="${u2Rev}">
          <m l="${u1CalFolderIdFQ}">
            <inv>
              <tz id="PacificTime" stdoff="-480" dayoff="-420">
                <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
              </tz>
              <comp fb="B" transp="O" allDay="0"
                    name="${subject}" loc="edit #2"
                    uid="${uid1}"
              >
                <s d="20070716T120000" tz="PacificTime"/>
                <e d="20070716T130000" tz="PacificTime"/>
                <or name="Demo User Two" a="${user2.name}"/>
                <at a="${user4.name}" role="REQ" ptst="NE"/>
                <recur>
                  <add>
                    <rule freq="DAI">
                      <interval ival="1"/>
                      <count num="5"/>
                    </rule>
                  </add>
                </recur>
              </comp>
            </inv>
            <su>${subject}</su>
            <mp ct="text/plain">
              <content>edit #2</content>
            </mp>
          </m>
        </ModifyAppointmentRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ModifyAppointmentResponse"/>
      </t:response>
    </t:test>
	-->
    <!-- View user1's meetings -->
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>

    <!-- Delete the meeting. -->
    <t:test id="delete">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>

















    <!-- ################################################################################### -->

    <!-- user1 is an attendee of user4's meeting.  user2 moves user1's meeting on-behalf-of. -->

    <t:property name="subject" value="user4 invited user1"/>

    <!-- Login as user4 -->
    <t:test id="user4">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user4.name}</account>
          <password>${user4.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Create an event -->
    <t:test id="user4 invites user1">
      <t:request>
        <CreateAppointmentRequest xmlns="urn:zimbraMail">
          <m>
            <e t="f" a="${user4.name}"/>
            <e t="t" a="${user1.name}"/>
            <inv>
              <tz id="PacificTime" stdoff="-480" dayoff="-420">
                <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
              </tz>
              <comp method="REQUEST" type="event" fb="B" transp="O"
                   status="CONF" class="PUB" allDay="0" name="${subject}">
                <s tz="PacificTime" d="20070716T100000"/>
                <e tz="PacificTime" d="20070716T110000"/>
                <or a="${user4.name}"
                    d="User Number 4"
                    language="en-US"
                />
                <at a="${user1.name}"
                    d="User Number 1"
                    role="REQ"
                    ptst="NE"
                    rsvp="1"
                />
              </comp>
            </inv>
            <mp ct="multipart/alternative">
              <mp ct="text/plain">
                <content>${subject}</content>
              </mp>
              <mp ct="text/html">
                <content>&lt;html&gt;&lt;body&gt;
&lt;i&gt;${subject}&lt;/i&gt;
&lt;/body&gt;&lt;/html&gt;</content>
              </mp>
            </mp>
            <su>${subject}</su>
          </m>
        </CreateAppointmentRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:CreateAppointmentResponse"/>
      </t:response>
    </t:test>
    <!-- Login as user2 -->
    <t:test id="user2">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user2.name}</account>
          <password>${user2.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- View user1's meetings -->
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    <!-- Move it from user1's calendar (remote) to user2's calendar (local) -->
    <!--
    <t:test id="move from user1 to user2">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="move" l="10"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user2's meetings -->
    <!--
    <t:test id="view user2 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="10"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u2CalItemId"/>
          <t:select attr="invId" set="u2InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it back from user2's calendar (local) to user1's calendar (remote) -->
    <!--
    <t:test id="move from user2 to user1">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u2CalItemId}" op="move" l="${u1CalFolderId}"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u2CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user1's meetings -->
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    <!-- Move it from user1's calendar (remote) to user3's calendar (remote) -->
    <!--
    <t:test id="move from user1 to user3">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="move" l="${u3CalFolderId}"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="move"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- View user3's meetings -->
    <!--
    <t:test id="view user3 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u3CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u3CalItemId"/>
          <t:select attr="invId" set="u3InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Delete the meeting. -->
    <!--
    <t:test id="delete from user3">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u3CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u3CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>
	-->









    <!-- ################################################################################### -->

    <!-- Move appointment in SetAppointment, possibly with simultaneous edits.  -->

    <t:property name="subject" value="Move via SetAppointment"/>

    <!-- Login as user1 -->
    <!--
    <t:test id="user1">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user1.name}</account>
          <password>${user1.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>
	-->
    <!-- Create an appointment, recurring with some exceptions -->
    <!--
    <t:test required="true" id="personal, recurrence, exceptions">
      <t:request>
        <SetAppointmentRequest xmlns="urn:zimbraMail" l="10">
          <default ptst="AC">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070716T150000" tz="PacificTime"/>
                  <e d="20070716T160000" tz="PacificTime"/>
                  <recur>
                    <add>
                      <rule freq="DAI">
                        <interval ival="1"/>
                        <count num="2"/>
                      </rule>
                    </add>
                  </recur>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>Originally in user1's calendar</content>
              </mp>
            </m>
          </default>
          <except ptst="TE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070717T150000" tz="PacificTime"/>
                  <e d="20070717T170000" tz="PacificTime"/>
                  <exceptId d="20070717T150000" tz="PacificTime"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one is twice as long.</content>
              </mp>
            </m>
          </except>
        </SetAppointmentRequest>
     </t:request>
     <t:response>
        <t:select path="//mail:SetAppointmentResponse" attr="calItemId" set="apptId"/>
     </t:response>
    </t:test>
	-->
    <!-- Login as user2 -->
    <!--
    <t:test id="user2">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user2.name}</account>
          <password>${user2.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>
	-->
    <!-- View user1's meetings -->
    <!--
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    -->
    <!-- Move it from user1's calendar (remote) to user3's calendar (remote), with some edits -->
    <!--
    <t:test id="delete from user1">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>
    <t:test required="true" id="create again in user3 calendar">
      <t:request>
        <SetAppointmentRequest xmlns="urn:zimbraMail" l="${u3CalFolderId}">
          <default ptst="AC">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="edit #1"
                      uid="${uid1}"
                >
                  <s d="20070716T150000" tz="PacificTime"/>
                  <e d="20070716T160000" tz="PacificTime"/>
                  <recur>
                    <add>
                      <rule freq="DAI">
                        <interval ival="1"/>
                        <count num="2"/>
                      </rule>
                    </add>
                  </recur>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>Now in user3's calendar</content>
              </mp>
            </m>
          </default>
          <except ptst="TE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070717T150000" tz="PacificTime"/>
                  <e d="20070717T170000" tz="PacificTime"/>
                  <exceptId d="20070717T150000" tz="PacificTime"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one is twice as long.</content>
              </mp>
            </m>
          </except>
        </SetAppointmentRequest>
     </t:request>
     <t:response>
        <t:select path="//mail:SetAppointmentResponse" attr="calItemId" set="apptId"/>
     </t:response>
    </t:test>
	-->
    <!-- View user3's meetings -->
    <!--
    <t:test id="view user3 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u3CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u3CalItemId"/>
          <t:select attr="invId" set="u3InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it from user3's calendar (remote) to user2's calendar (local), with some edits -->
    <!--
    <t:test id="delete from user3">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u3CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u3CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>
    <t:test required="true" id="create again in user2">
      <t:request>
        <SetAppointmentRequest xmlns="urn:zimbraMail" l="10">
          <default ptst="AC">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="edit #2"
                      uid="${uid1}"
                >
                  <s d="20070716T150000" tz="PacificTime"/>
                  <e d="20070716T160000" tz="PacificTime"/>
                  <recur>
                    <add>
                      <rule freq="DAI">
                        <interval ival="1"/>
                        <count num="2"/>
                      </rule>
                    </add>
                  </recur>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>Now in user2's calendar</content>
              </mp>
            </m>
          </default>
          <except ptst="TE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070717T150000" tz="PacificTime"/>
                  <e d="20070717T170000" tz="PacificTime"/>
                  <exceptId d="20070717T150000" tz="PacificTime"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one is twice as long.</content>
              </mp>
            </m>
          </except>
        </SetAppointmentRequest>
     </t:request>
     <t:response>
        <t:select path="//mail:SetAppointmentResponse" attr="calItemId" set="apptId"/>
     </t:response>
    </t:test>
	-->
    <!-- View user2's meetings -->
    <!--
    <t:test id="view user2 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="10"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u2CalItemId"/>
          <t:select attr="invId" set="u2InvId"/>
        </t:select>
      </t:response>
    </t:test>
	-->
    <!-- Move it from user2's calendar (local) to user1's calendar (remote), with some edits -->
    <!--
    <t:test id="delete from user2">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u2CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u2CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>
    <t:test required="true" id="create again in user1 calendar">
      <t:request>
        <SetAppointmentRequest xmlns="urn:zimbraMail" l="${u1CalFolderId}">
          <default ptst="AC">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="edit #3"
                      uid="${uid1}"
                >
                  <s d="20070716T150000" tz="PacificTime"/>
                  <e d="20070716T160000" tz="PacificTime"/>
                  <recur>
                    <add>
                      <rule freq="DAI">
                        <interval ival="1"/>
                        <count num="2"/>
                      </rule>
                    </add>
                  </recur>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>Now back in user1's calendar</content>
              </mp>
            </m>
          </default>
          <except ptst="TE">
            <m>
              <inv>
                <tz id="PacificTime" stdoff="-480" dayoff="-420">
                  <standard week="-1" wkday="1" mon="10" hour="2" min="0" sec="0"/>
                  <daylight week="1" wkday="1" mon="4" hour="2" min="0" sec="0"/>
                </tz>
                <comp fb="B" transp="O" allDay="0"
                      name="${subject}" loc="somewhere"
                      uid="${uid1}"
                >
                  <s d="20070717T150000" tz="PacificTime"/>
                  <e d="20070717T170000" tz="PacificTime"/>
                  <exceptId d="20070717T150000" tz="PacificTime"/>
                </comp>
              </inv>
              <su>${subject}</su>
              <mp ct="text/plain">
                <content>This one is twice as long.</content>
              </mp>
            </m>
          </except>
        </SetAppointmentRequest>
     </t:request>
     <t:response>
        <t:select path="//mail:SetAppointmentResponse" attr="calItemId" set="apptId"/>
     </t:response>
    </t:test>
	-->
    <!-- View user1's meetings -->
    <!--
    <t:test id="view user1 meetings">
      <t:request>
        <GetApptSummariesRequest xmlns="urn:zimbraMail"
          s="1183248000000"
          e="1185926400000"
          l="${u1CalFolderId}"/>
      </t:request>
      <t:response>
        <t:select path="//mail:GetApptSummariesResponse/mail:appt" attr="name" match="${subject}">
          <t:select attr="id" set="u1CalItemId"/>
          <t:select attr="invId" set="u1InvId"/>
        </t:select>
      </t:response>
    </t:test>
    -->
    <!-- Delete the meeting. -->
    <!--
    <t:test id="delete">
      <t:request>
        <ItemActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalItemId}" op="delete"/>
        </ItemActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:ItemActionResponse/mail:action">
          <t:select attr="id" match="${u1CalItemId}"/>
          <t:select attr="op" match="delete"/>
        </t:select>
      </t:response>
    </t:test>
    -->





    <!-- ################################################################################### -->

    <!-- CLEANUP -->

    <!-- Clear on-behalf-of -->
    <t:property name="target" value=""/>

    <!-- Login as user2 -->
    <t:test id="user2">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user2.name}</account>
          <password>${user2.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Remove user1's calendar from user2's view -->
    <t:test id="unmount user1 calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="${u1CalFolderId}" op="delete"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action"
                  attr="id" match="${u1CalFolderId}"/>
      </t:response>
    </t:test>

    <!-- Remove user3's calendar from user2's view -->
    <t:test id="unmount user3 calendar">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action id="${u3CalFolderId}" op="delete"/>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse/mail:action"
                  attr="id" match="${u3CalFolderId}"/>
      </t:response>
    </t:test>

    <!-- Login as user1 -->
    <t:test id="user1">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user1.name}</account>
          <password>${user1.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Revoke calendar admin rights from user2 -->
    <t:test id="revoke from user2">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
    	<action op="!grant" id="10" zid="${account2.id}">
            <grant gt="usr" inh="1" d="${user2.name}" perm="rwidx"/>
          </action>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse"/>
      </t:response>
    </t:test>

    <!-- Login as user3 -->
    <t:test id="user3">
      <t:request>
        <AuthRequest xmlns="urn:zimbraAccount">
          <account by="name">${user3.name}</account>
          <password>${user3.password}</password>
        </AuthRequest>
      </t:request>
      <t:response>
        <t:select path="//acct:AuthResponse/acct:lifetime"  match="^\d+$"/>
        <t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>

      </t:response>
    </t:test>

    <!-- Revoke calendar admin rights from user2 -->
    <t:test id="revoke from user2">
      <t:request>
        <FolderActionRequest xmlns="urn:zimbraMail">
          <action op="!grant" id="10" zid="${account2.id}">
            <grant gt="usr" inh="1" d="${user2.name}" perm="rwidx"/>
          </action>
        </FolderActionRequest>
      </t:request>
      <t:response>
        <t:select path="//mail:FolderActionResponse"/>
      </t:response>
    </t:test>

</t:test_case>

</t:tests>
