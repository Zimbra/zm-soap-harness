<t:tests
	xmlns:t="urn:zimbraTestHarness"
	xmlns:admin="urn:zimbraAdmin"
	xmlns:mail="urn:zimbraMail"
	xmlns:acct="urn:zimbraAccount">
	<!-- Define properties for accounts -->
	<t:property name="domain0.name" value="${TIME}${COUNTER}"/>
	<t:property name="account1.name" value="account1.${TIME}.${COUNTER}@${defaultdomain.name}"/>
	<t:property name="account2.name" value="account2.${TIME}.${COUNTER}@${defaultdomain.name}"/>
	<t:property name="account3.name" value="account3.${TIME}.${COUNTER}@externaldomain.com"/>
	<t:property name="account4.name" value="account4.${TIME}.${COUNTER}@domain${domain0.name}"/>
	<t:property name="alias.name" value="Alias.${TIME}.${COUNTER}@${defaultdomain.name}"/>
	<t:property name="account1.reply" value="I am currently out of office"/>
	<t:property name="account4.reply" value="I am currently out of office"/>
	<!-- Admin authentication for setting up accounts -->
	<t:test_case testcaseid="AdminSetup" type="always">
		<t:objective>Admin login and account setup</t:objective>
		<t:test id="ping" required="true">
			<t:request>
				<PingRequest
					xmlns="urn:zimbraAdmin"/>
				</t:request>
				<t:response>
					<t:select path="//admin:PingResponse"/>
				</t:response>
			</t:test>
			<t:test id="admin_login" required="true" depends="ping">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAdmin">
						<name>${admin.user}</name>
						<password>${admin.password}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:AuthResponse/admin:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<!-- Create Internal Domain -->
			<t:steps> 
            1. Create a new Domain 
        </t:steps>
			<t:test id="CreateDomainRequest0a">
				<t:request>
					<CreateDomainRequest
						xmlns="urn:zimbraAdmin">
						<name>domain${domain0.name}</name>
					</CreateDomainRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:CreateDomainResponse/admin:domain" attr="id" set="domain0.id"/>
				</t:response>
			</t:test>
			<!-- Account 1 Creation -->
			<t:test id="create_account1" required="true" depends="admin_login">
				<t:request>
					<CreateAccountRequest
						xmlns="urn:zimbraAdmin">
						<name>${account1.name}</name>
						<password>${defaultpassword.value}</password>
					</CreateAccountRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:CreateAccountResponse/admin:account" attr="id" set="account1.id"/>
					<t:select path='//admin:CreateAccountResponse/admin:account/admin:a[@n="zimbraMailHost"]' set="account1.server"/>
				</t:response>
			</t:test>
			<!-- Account 2 Creation -->
			<t:test id="create_account2" required="true" depends="admin_login">
				<t:request>
					<CreateAccountRequest
						xmlns="urn:zimbraAdmin">
						<name>${account2.name}</name>
						<password>${defaultpassword.value}</password>
					</CreateAccountRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:CreateAccountResponse/admin:account" attr="id" set="account2.id"/>
					<t:select path='//admin:CreateAccountResponse/admin:account/admin:a[@n="zimbraMailHost"]' set="account2.server"/>
				</t:response>
			</t:test>
			<!-- Custom Domain Account 3 Creation -->
			<t:test id="create_account3" required="true" depends="admin_login">
				<t:request>
					<CreateAccountRequest
						xmlns="urn:zimbraAdmin">
						<name>${account4.name}</name>
						<password>${defaultpassword.value}</password>
					</CreateAccountRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:CreateAccountResponse/admin:account" attr="id" set="account4.id"/>
					<t:select path='//admin:CreateAccountResponse/admin:account/admin:a[@n="zimbraMailHost"]' set="account4.server"/>
				</t:response>
			</t:test>
		</t:test_case>
		<!-- Set OOO message for Account 1 -->
		<t:test_case testcaseid="SetOOO" type="bhr" depends="AdminSetup">
			<t:objective>Account 1 sets Out Of Office message</t:objective>
			<t:property name="server.zimbraAccount" value="${account1.server}"/>
			<t:test id="auth_account1" required="true">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAccount">
						<account by="name">${account1.name}</account>
						<password>${defaultpassword.value}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<!-- Enable OOO with From and untilDate in the past -->
			<t:test id="set_ooo_until_date" required="true" depends="auth_account1">
				<t:request>
					<ModifyPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeReply">${account1.reply}</pref>
						<pref name="zimbraPrefOutOfOfficeStatusAlertOnLogin">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeFromDate">20240827145900Z</pref>
						<pref name="zimbraPrefOutOfOfficeUntilDate">20240831145900Z</pref>
					</ModifyPrefsRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:ModifyPrefsResponse"/>
				</t:response>
			</t:test>
			<t:delay sec="15"/>
			<t:test id="get_ooo_prefs" required="true">
				<t:request>
					<GetPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled"/>
						<pref name="zimbraPrefOutOfOfficeReply"/>
						<pref name="zimbraPrefOutOfOfficeFromDate"/>
						<pref name="zimbraPrefOutOfOfficeUntilDate"/>
					</GetPrefsRequest>
				</t:request>
				<t:response>
					<!-- OOO enabled -->
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeReplyEnabled']"
                  match="TRUE"/>
					<!-- OOO message -->
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeReply']"
                  match="${account1.reply}"/>
					<!-- From date : yyyyMMddHHmmssZ -->
					<t:select
        path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeFromDate']"
        match="^\d{14}Z$"/>
					<!-- Until date : yyyyMMddHHmmssZ -->
					<t:select
        path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeUntilDate']"
        match="^\d{14}Z$"/>
				</t:response>
			</t:test>
		</t:test_case>
		<t:test_case testcaseid="Set_OOO_Future_2025" type="bhr" depends="AdminSetup">
			<t:objective>
        Verify Out Of Office preference is enabled and set for a future date
    </t:objective>
			<!-- ================= AUTH : ACCOUNT 1 ================= -->
			<t:test id="auth_account1" required="true">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAccount">
						<account by="name">${account1.name}</account>
						<password>${defaultpassword.value}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:AuthResponse/acct:authToken"
                      set="authToken"/>
				</t:response>
			</t:test>
			<t:test>
				<t:request>
					<ModifyPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeReply">I am currently out of office</pref>
						<pref name="zimbraPrefOutOfOfficeStatusAlertOnLogin">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeFromDate">20240827145900Z</pref>
						<pref name="zimbraPrefOutOfOfficeUntilDate">20300831145900Z</pref>
					</ModifyPrefsRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:ModifyPrefsResponse"/>
				</t:response>
			</t:test>
			<!-- ================= VERIFY OOO PREFS ================= -->
			<t:test id="verify_ooo_prefs" required="true" depends="set_ooo_future">
				<t:request>
					<GetPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled"/>
						<pref name="zimbraPrefOutOfOfficeReply"/>
						<pref name="zimbraPrefOutOfOfficeUntilDate"/>
					</GetPrefsRequest>
				</t:request>
				<t:response>
					<!-- OOO ENABLED -->
					<t:select path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeReplyEnabled']"
                      match="TRUE"/>
					<!-- OOO MESSAGE -->
					<t:select path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeReply']"
                      match="${account1.reply}"/>
					<t:select
    path="//acct:pref[@name='zimbraPrefOutOfOfficeUntilDate']"
    match="^\d{14}Z$"/>
				</t:response>
			</t:test>
		</t:test_case>
		<t:test_case testcaseid="VerifyOOO_ExternalDomain" type="bhr" depends="Set_OOO_Future_2025">
			<t:objective>
        Verify Out Of Office preference is account scoped and not applicable to external domain
    </t:objective>
			<!-- AUTH AS ACCOUNT 1 -->
			<t:test id="auth_account1" required="true">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAccount">
						<account by="name">${account1.name}</account>
						<password>${defaultpassword.value}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<!-- VERIFY OOO PREF EXISTS ONLY FOR ACCOUNT1 -->
			<t:test id="verify_ooo_account_scoped" required="true" depends="auth_account1">
				<t:request>
					<GetPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled"/>
					</GetPrefsRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeReplyEnabled']"
                      match="TRUE"/>
				</t:response>
			</t:test>
		</t:test_case>
		<t:test_case testcaseid="VerifyOOO_DistributionList" type="bhr" depends="Set_OOO_Future_2025">
			<t:objective>
        Verify Out Of Office preference does not apply to distribution lists
    </t:objective>
			<!-- AUTH AS ACCOUNT 1 -->
			<t:test id="auth_account1" required="true">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAccount">
						<account by="name">${account1.name}</account>
						<password>${defaultpassword.value}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:AuthResponse/acct:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<!-- VERIFY DL HAS NO OOO PREF -->
			<t:test id="verify_dl_no_ooo" required="true" depends="auth_account1">
				<t:request>
					<GetPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled"/>
					</GetPrefsRequest>
				</t:request>
				<t:response>
					<!-- Preference exists only for authenticated user, not DL -->
					<t:select path="//acct:GetPrefsResponse/acct:pref[@name='zimbraPrefOutOfOfficeReplyEnabled']"
                      match="TRUE"/>
				</t:response>
			</t:test>
		</t:test_case>
		<t:test_case testcaseid="Set LC True" type="bhr">
			<t:objective>Set LC get_out_of_office_cross_domains to TRUE </t:objective>
			<t:staftask>
				<t:request>
					<server>${zimbraServer.name}</server>
					<service>PROCESS</service>
					<params>START SHELL COMMAND "su - zimbra -c \'zmlocalconfig -e get_out_of_office_cross_domains=true'" RETURNSTDOUT RETURNSTDERR WAIT
                    ${staf.process.timeout.zmmtactl}</params>
				</t:request>
			</t:staftask>
			<t:staftask>
				<t:request>
					<server>${zimbraServer.name}</server>
					<service>PROCESS</service>
					<params>START SHELL COMMAND "su - zimbra -c \'zmmailboxdctl restart'" RETURNSTDOUT RETURNSTDERR WAIT
                    ${staf.process.timeout.zmmtactl}</params>
				</t:request>
			</t:staftask>
			<!-- Sleep for 1 minute to wait for mbox to come up -->
			<t:delay sec="30"/>
		</t:test_case>
		<!-- Set zimbraPrefOutOfOfficeSuppressExternalReply True for Account 1 -->
		<t:test_case testcaseid="Set zimbraPrefOutOfOfficeSuppressExternalReply True" type="bhr">
			<t:objective>Set zimbraPrefOutOfOfficeSuppressExternalReply to TRUE </t:objective>
			<!-- Admin Auth for Modify Account -->
			<t:test id="admin_login" required="true" depends="ping">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAdmin">
						<name>${admin.user}</name>
						<password>${admin.password}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:AuthResponse/admin:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<t:test>
				<t:request>
					<ModifyAccountRequest
						xmlns="urn:zimbraAdmin">
						<id>${account1.id}</id>
						<a n="zimbraPrefOutOfOfficeSuppressExternalReply">TRUE</a>
						<a n="zimbraInternalSendersDomain">${defaultdomain.name}</a>
					</ModifyAccountRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:ModifyAccountResponse" />
					<t:select path="//admin:ModifyAccountResponse/admin:account[@id='${account1.id}']" />
				</t:response>
			</t:test>
		</t:test_case>
		<!-- ========================================================= -->
		<!-- Custom Domain OOO with External Suppression -->
		<!-- ========================================================= -->
		<t:test_case testcaseid="OOO_CustomDomain_SuppressExternal"
             type="bhr"
             depends="AdminSetup">
			<t:objective>
        Verify Custom Domain account has OOO enabled and
        external OOO replies are suppressed
    </t:objective>
			<t:test id="admin_login" required="true" depends="ping">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAdmin">
						<name>${admin.user}</name>
						<password>${admin.password}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:AuthResponse/admin:authToken" set="authToken"/>
				</t:response>
			</t:test>
			<!-- ================= SET SUPPRESS EXTERNAL OOO ================= -->
			<t:test id="set_suppress_external_ooo"
            required="true"
            depends="admin_login">
				<t:request>
					<ModifyAccountRequest
						xmlns="urn:zimbraAdmin">
						<id>${account4.id}</id>
						<a n="zimbraPrefOutOfOfficeSuppressExternalReply">TRUE</a>
					</ModifyAccountRequest>
				</t:request>
				<t:response>
					<t:select path="//admin:ModifyAccountResponse"/>
				</t:response>
			</t:test>
			<!-- ================= AUTH ACCOUNT 4 ================= -->
			<t:property name="server.zimbraAccount" value="${account4.server}"/>
			<t:test id="auth_account4" required="true">
				<t:request>
					<AuthRequest
						xmlns="urn:zimbraAccount">
						<account by="name">${account4.name}</account>
						<password>${defaultpassword.value}</password>
					</AuthRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:AuthResponse/acct:authToken"
                      set="authToken"/>
				</t:response>
			</t:test>
			<!-- ================= SET OOO (NO HARDCODING) ================= -->
			<t:test id="set_ooo_account4"
            required="true"
            depends="auth_account4">
				<t:request>
					<ModifyPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeReply">${account4.reply}</pref>
						<pref name="zimbraPrefOutOfOfficeStatusAlertOnLogin">TRUE</pref>
						<pref name="zimbraPrefOutOfOfficeFromDate">20240827145900Z</pref>
						<pref name="zimbraPrefOutOfOfficeUntilDate">20300831145900Z</pref>
					</ModifyPrefsRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:ModifyPrefsResponse"/>
				</t:response>
			</t:test>
			<!-- ================= VERIFY OOO PREFS ================= -->
			<t:test id="verify_ooo_prefs_account4"
            required="true"
            depends="set_ooo_account4">
				<t:request>
					<GetPrefsRequest
						xmlns="urn:zimbraAccount">
						<pref name="zimbraPrefOutOfOfficeReplyEnabled"/>
						<pref name="zimbraPrefOutOfOfficeReply"/>
						<pref name="zimbraPrefOutOfOfficeFromDate"/>
						<pref name="zimbraPrefOutOfOfficeUntilDate"/>
					</GetPrefsRequest>
				</t:request>
				<t:response>
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeReplyEnabled']"
                      match="TRUE"/>
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeReply']"
                      match="${account4.reply}"/>
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeFromDate']"
                      match="^\d{14}Z$"/>
					<t:select path="//acct:pref[@name='zimbraPrefOutOfOfficeUntilDate']"
                      match="^\d{14}Z$"/>
				</t:response>
			</t:test>
			<!-- Setting get_out_of_office_cross_domains=false back to Default -->
			<t:staftask>
				<t:request>
					<server>${zimbraServer.name}</server>
					<service>PROCESS</service>
					<params>START SHELL COMMAND "su - zimbra -c \'zmlocalconfig -e get_out_of_office_cross_domains=false'" RETURNSTDOUT RETURNSTDERR WAIT
                    ${staf.process.timeout.zmmtactl}</params>
				</t:request>
			</t:staftask>
			<t:staftask>
				<t:request>
					<server>${zimbraServer.name}</server>
					<service>PROCESS</service>
					<params>START SHELL COMMAND "su - zimbra -c \'zmmailboxdctl restart'" RETURNSTDOUT RETURNSTDERR WAIT
                    ${staf.process.timeout.zmmtactl}</params>
				</t:request>
			</t:staftask>
			<!-- Sleep for 1 minute to wait for mbox to come up -->
			<t:delay sec="30"/>
		</t:test_case>
	</t:tests>